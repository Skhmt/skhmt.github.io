(function(){function D(){function D(){m("https://api.twitch.tv/kraken/streams/"+c+"?client_id="+w+"&api_version=3",function(a){a.stream?(x=!0,E=a.stream.viewers,I=a.stream.average_fps,J=a.stream.video_height,K=a.stream.delay):x=!1});m("https://api.twitch.tv/kraken/channels/"+c+"?client_id="+w+"&api_version=3",function(a){z=a.game;A=a.status;L=a.followers;M=a.views;F=a.partner;N=a.created_at;O=a.logo;P=a.video_banner;Q=a.profile_banner});m("https://api.twitch.tv/kraken/channels/"+c+"/follows?client_id="+
w+"&api_version=3&limit=100",function(a){if(a.follows){var b=!0;0<G.length&&(b=!1);for(var d=0;d<a.follows.length;d++){var c=a.follows[d].user.display_name;-1===G.indexOf(c)&&(b||p("follow",c),G.push(c))}}});m("https://tmi.twitch.tv/group/user/"+c+"/chatters?client_id="+w+"&api_version=3",function(a){t||(a=a.data);if(!a.chatters)return console.log("No response for user list.");E=a.chatter_count;y.moderators=a.chatters.moderators.slice();y.staff=a.chatters.staff.slice();y.admins=a.chatters.admins.slice();
y.global_mods=a.chatters.global_mods.slice();y.viewers=a.chatters.viewers.slice()});setTimeout(function(){t||(document.querySelector("#tapicJsonpContainer").innerHTML="");D()},1E4)}function Z(a){m("https://api.twitch.tv/kraken/chat/"+c+"/badges?api_version=3",function(c){c.subscriber&&(R=c.subscriber.image);a&&a()})}function p(a,c){if(B.has(a))for(var b=B.get(a),f=0;f<b.length;f++)b[f](c)}function m(a,c){if(t)require("https").get(a,function(a){var b="";a.setEncoding("utf8");a.on("data",function(a){b+=
a});a.on("end",function(){200<=a.statusCode&&400>a.statusCode?c(JSON.parse(b)):console.error(b)})}).on("error",function(a){console.error(a.message)});else{var b;do b="jsonp"+Math.floor(1E6*Math.random());while(window[b]);window[b]=function(a){c(a);delete window[b]};var f=document.createElement("script");f.src=a+"&callback="+b;document.querySelector("#tapicJsonpContainer").appendChild(f)}}var b={},w="",C="",H="",c="",k,x=!1,z="",A="",L="",M="",F="",E="",I="",J="",K="",R="",y={},G=[],N="",O="",P="",
Q="",t=!1,B=new Map,W="",X="",Y="",S="",T="",U="",V="";"undefined"!==typeof module&&"undefined"!==typeof module.exports&&(t=!0);b.setup=function(a,b,c){a&&b?(w=a,C=b,t||(a=document.createElement("div"),a.id="tapicJsonpContainer",a.style.cssText="display:none;",document.getElementsByTagName("body")[0].appendChild(a)),m("https://api.twitch.tv/kraken?client_id="+w+"&oauth_token="+C+"&api_version=3",function(a){H=a.token.user_name;c&&c(H)})):console.error("Invalid parameters. Usage: TAPIC.setup(clientid, oauth[, callback]);")};
b.runChat=function(a,h){function d(){k.send("CAP REQ :twitch.tv/tags twitch.tv/commands twitch.tv/membership");k.send("PASS oauth:"+C);k.send("NICK "+H);k.send("JOIN #"+c)}function f(a){a=t?a.split("\r\n"):a.data.split("\r\n");for(var b=0;b<a.length;b++){var g=a[b];if("PING :tmi.twitch.tv"===g)k.send("PONG :tmi.twitch.tv");else if(g){p("raw",g);var e=g.split(" ");if("PRIVMSG"===e[2]){g=e[0];e.splice(0,1);for(var d=e,f=g.split(";"),g="#d2691e",h=e=!1,m=!1,u="",v="",l=0;l<f.length;l++){f[l]=f[l].split("=");
var q=f[l][0],n=f[l][1];"display-name"===q?u=""===n?d[0].split("!")[0].substring(1):n:"@color"===q&&""!==n?g=n:"mod"===q&&"1"==n?e=!0:"subscriber"===q&&"1"==n?h=!0:"turbo"===q&&"1"==n?m=!0:"emotes"===q&&""!==n&&(v=n)}f=!1;l=d[3].substring(1);d.splice(0,4);d=d.join(" ");"\u0001ACTION"===l?(l=d,f=!0):l+=" "+d;d=l.replace(/</g,"&lt;").replace(/>/g,"&gt;");p("message",{from:u,color:g,mod:e,sub:h,turbo:m,streamer:u.toLowerCase()===c.toLowerCase(),action:f,text:d,emotes:v})}else if("PRIVMSG"===e[1])p("host",
e[3].substring(1));else if("NOTICE"===e[2])e.splice(0,4),g=e.join(" ").substring(1),p("notice",g);else if("JOIN"===e[1])g=e[0].split("!")[0].substring(1),p("join",g);else if("PART"===e[1])g=e[0].split("!")[0].substring(1),p("part",g);else if("ROOMSTATE"===e[2]){g=e[0].substring(1).split(";");u=m=h=e=void 0;for(v=0;v<g.length;v++)d=g[v].split("="),"broadcaster-lang"===d[0]?e=d[1]:"r9k"===d[0]?h=d[1]:"slow"===d[0]?m=d[1]:"subs-only"===d[0]&&(u=d[1]);p("roomstate",{lang:e,r9k:h,slow:m,subs_only:u})}else if("WHISPER"===
e[2]){g=e;e="#d2691e";h="";m=!1;f=d=v=u="";l=g[0].split(";");for(q=0;q<l.length;q++){l[q]=l[q].split("=");var n=l[q][0],r=l[q][1];"display-name"===n?u=""===r?g[1].split("!")[0].substring(1):r:"@color"===n&&""!==r?e=r:"turbo"===n&&"1"==r?m=!0:"emotes"===n&&""!==r?h=r:"message-id"===n&&""!==r?v=r:"thread-id"===n&&""!==r?d=r:"user-id"===n&&""!==r&&(f=r)}l=g.slice(4).join(" ").substring(1);p("whisper",{from:u,to:g[3],color:e,emotes:h,turbo:m,message_id:v,thread_id:d,user_id:f,text:l})}else if("CLEARCHAT"===
e[1])4===e.length?(g=e[3].substring(1),p("clearUser",g)):p("clearChat");else if("USERSTATE"===e[2])for(g=e[0].substring(1).split(";"),e=0;e<g.length;e++)h=g[e].split("="),"color"===h[0]?X=h[1]:"display-name"===h[0]?W=h[1]:"emote-sets"===h[0]?Y=h[1]:"mod"===h[0]?S=h[1]:"subscriber"===h[0]?T=h[1]:"turbo"===h[0]?U=h[1]:"user-type"===h[0]&&(V=h[1])}}}H&&C||console.error("TAPIC not set up, cannot run chat.");k&&b.closeChat();c=a.toLowerCase();k=t?new (require("ws"))("ws://irc-ws.chat.twitch.tv:80"):new WebSocket("ws://irc-ws.chat.twitch.tv:80");
t?(k.on("open",d),k.on("message",f)):(k.onopen=d,k.onmessage=f);Z(function(){D();h&&setTimeout(h,500)})};b.closeChat=function(){if(!k)return console.error("Chat is not open.");k.close();console.log("Chat closed.");k=c="";x=!1;R=K=J=I=E=F=M=L=A=z="";y={};G=[];V=U=T=S=Y=X=W=Q=P=O=N=""};b.changeChannel=function(a){if(!k)return console.error("Chat is not open.");k.send("PART #"+c);c=a;x=!1;R=K=J=I=E=F=M=L=A=z="";y={};G=[];V=U=T=S=Q=P=O=N="";k.send("JOIN #"+c)};b.sendChat=function(a){if(!k)return console.error("Chat is not open.");
k.send("PRIVMSG #"+c+" :"+a);p("echoChat",a)};b.sendWhisper=function(a,b){if(!k)return console.error("Chat is not open.");k.send("PRIVMSG #jtv :/w "+a+" "+b);p("echoWhisper",{to:a,text:b})};b.getUsername=function(){return H};b.getChannel=function(){return c};b.isOnline=function(){return c?x:console.error("Not in a channel.")};b.getStatus=function(){return c?A:console.error("Not in a channel.")};b.getGame=function(){return c?z:console.error("Not in a channel.")};b.getFollowerCount=function(){return c?
L:console.error("Not in a channel.")};b.getTotalViewCount=function(){return c?M:console.error("Not in a channel.")};b.isPartner=function(){return c?F:console.error("Not in a channel.")};b.getCurrentViewCount=function(){return c?E:console.error("Not in a channel.")};b.getFps=function(){return x?I:console.error("Stream not online.")};b.getVideoHeight=function(){return x?J:console.error("Stream not online.")};b.getDelay=function(){return x?K:console.error("Stream not online.")};b.getSubBadgeUrl=function(){return c?
R:console.error("Not in a channel.")};b.getChatters=function(){return c?y:console.error("Not in a channel.")};b.getCreatedAt=function(){return c?N:console.error("Not in a channel.")};b.getLogo=function(){return c?O:console.error("Not in a channel.")};b.getVideoBanner=function(){return c?P:console.error("Not in a channel.")};b.getProfileBanner=function(){return c?Q:console.error("Not in a channel.")};b.getDisplayName=function(){return c?W:console.error("Not in a channel.")};b.getColor=function(){return c?
X:console.error("Not in a channel.")};b.getEmoteSets=function(){return c?Y:console.error("Not in a channel.")};b.getMod=function(){return c?S:console.error("Not in a channel.")};b.getSub=function(){return c?T:console.error("Not in a channel.")};b.getTurbo=function(){return c?U:console.error("Not in a channel.")};b.getUserType=function(){return c?V:console.error("Not in a channel.")};b.isFollowing=function(a,b,c){m("https://api.twitch.tv/kraken/users/"+a+"/follows/channels/"+b+"?api_version=3&client_id="+
w,function(a){a.error?c({isFollowing:!1}):c({isFollowing:!0,dateFollowed:(new Date(a.created_at)).toLocaleString()})})};b.isSubscribing=function(a,b,c){m("https://api.twitch.tv/kraken/channels/"+b+"/subscriptions/"+a+"?api_version=3client_id="+w,function(a){a.error?c({isSubscribing:!1}):c({isSubscribing:!0,dateSubscribed:(new Date(a.created_at)).toLocaleString()})})};b.runCommercial=function(a){F||console.error("Not a partner, cannot run a commercial.");c||console.error("Not in a channel.");a||(a=
30);var b="/kraken/channels/"+c+"/commercial?oauth_token="+C,d="https://api.twitch.tv"+b;t?(d={host:"https://api.twitch.tv",path:b,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}},require("https").request(d).write("length="+a).end()):(b=new XMLHttpRequest,b.open("POST",d,!0),b.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),b.send("length="+a))};b.setStatusGame=function(a,b){a||(a=A);b||(b=z);var d="https://api.twitch.tv/kraken/channels/"+
c,d=d+("?channel[status]="+encodeURIComponent(a)),d=d+("&channel[game]="+encodeURIComponent(b)),d=d+("&_method=put&oauth_token="+C);if(t)require("https").get(d,function(a){var b="";a.setEncoding("utf8");a.on("data",function(a){b+=a});a.on("end",function(){if(200<=a.statusCode&&400>a.statusCode){var c=JSON.parse(b);z=c.game;A=c.status}else console.error(b)})}).on("error",function(a){console.error(a.message)});else{var f=new XMLHttpRequest;f.open("GET",d,!0);f.onload=function(){if(200<=f.status&&400>
f.status){var a=JSON.parse(f.responseText);z=a.game;A=a.status}else console.error(f.responseText)};f.onerror=function(){console.error(f.responseText)};f.send()}};b.listen=function(a,b){if(B.has(a)){var c=B.get(a);c.push(b);B.set(a,c)}else B.set(a,[b])};return b}"undefined"!==typeof module&&"undefined"!==typeof module.exports?module.exports=D():"undefined"===typeof TAPIC?window.TAPIC=D():console.error("TAPIC already defined.")})();
