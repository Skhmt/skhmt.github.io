(function(){function C(){function C(){w("https://api.twitch.tv/kraken/streams/"+c+"?client_id="+x+"&api_version=3",function(a){a.stream?(y=!0,F=a.stream.viewers,J=a.stream.average_fps,K=a.stream.video_height,L=a.stream.delay):y=!1});w("https://api.twitch.tv/kraken/channels/"+c+"?client_id="+x+"&api_version=3",function(a){A=a.game;B=a.status;M=a.followers;N=a.views;G=a.partner;O=a.created_at;P=a.logo;Q=a.video_banner;R=a.profile_banner});w("https://api.twitch.tv/kraken/channels/"+c+"/follows?client_id="+
x+"&api_version=3&limit=100",function(a){if(a.follows){var b=!0;0<H.length&&(b=!1);for(var e=0;e<a.follows.length;e++){var c=a.follows[e].user.display_name;-1===H.indexOf(c)&&(b||t("follow",c),H.push(c))}}});w("https://tmi.twitch.tv/group/user/"+c+"/chatters?client_id="+x+"&api_version=3",function(a){u||(a=a.data);if(!a.chatters)return console.log("No response for user list.");F=a.chatter_count;z.moderators=a.chatters.moderators.slice();z.staff=a.chatters.staff.slice();z.admins=a.chatters.admins.slice();
z.global_mods=a.chatters.global_mods.slice();z.viewers=a.chatters.viewers.slice()});setTimeout(function(){u||(document.querySelector("#twapiJsonpContainer").innerHTML="");C()},1E4)}function aa(a){w("https://api.twitch.tv/kraken/chat/"+c+"/badges?api_version=3",function(c){null!=c.subscriber&&(S=c.subscriber.image);a&&a()})}function t(a,c){if(D.has(a)){var b=D.get(a),f;for(f in b)b[f](c)}}function w(a,c){if(u)require("https").get(a,function(a){var b="";a.setEncoding("utf8");a.on("data",function(a){b+=
a});a.on("end",function(){200<=a.statusCode&&400>a.statusCode?c(JSON.parse(b)):console.error(b)})}).on("error",function(a){console.error(a.message)});else{var b;do b="jsonp"+Math.floor(1E6*Math.random());while(window[b]);window[b]=function(a){c(a);delete window[b]};var f=document.createElement("script");f.src=a+"&callback="+b;document.querySelector("#twapiJsonpContainer").appendChild(f)}}var b={},x="",E="",I="",c="",k,y=!1,A="",B="",M="",N="",G="",F="",J="",K="",L="",S="",z={},H=[],O="",P="",Q="",
R="",u=!1,D=new Map,X="",Y="",Z="",T="",U="",V="",W="";"undefined"!==typeof module&&"undefined"!==typeof module.exports&&(u=!0,console.info("TWAPI is running in Node.js."));b.setup=function(a,b,c){a&&b||console.error("Invalid parameters. Usage: TWAPI.setup(clientid, oauth, callback);");x=a;E=b;u||(a=document.createElement("div"),a.id="twapiJsonpContainer",a.style.cssText="display:none;",document.getElementsByTagName("body")[0].appendChild(a));w("https://api.twitch.tv/kraken?client_id="+x+"&oauth_token="+
E+"&api_version=3",function(a){I=a.token.user_name;c&&c(I)})};b.runChat=function(a,r){function e(){k.send("CAP REQ :twitch.tv/tags twitch.tv/commands twitch.tv/membership");k.send("PASS oauth:"+E);k.send("NICK "+I);k.send("JOIN #"+c)}function f(a){a=u?a.split("\r\n"):a.data.split("\r\n");for(var b=0;b<a.length;b++){var g=a[b];if("PING :tmi.twitch.tv"===g)k.send("PONG :tmi.twitch.tv");else if(g){t("raw",g);var d=g.split(" ");if("PRIVMSG"===d[2]){g=d[0];d.splice(0,1);for(var e=d,f=g.split(";"),g="#d2691e",
h=d=!1,r=!1,v="",n="",l=0;l<f.length;l++){f[l]=f[l].split("=");var p=f[l][0],m=f[l][1];"display-name"===p?v=""===m?e[0].split("!")[0].substring(1):m:"@color"===p&&""!=m?g=m:"mod"===p&&"1"==m?d=!0:"subscriber"===p&&"1"==m?h=!0:"turbo"===p&&"1"==m?r=!0:"emotes"===p&&""!=m&&(n=m)}f=!1;l=e[3].substring(1);e.splice(0,4);e=e.join(" ");"\u0001ACTION"===l?(l=e,f=!0):l+=" "+e;e=l.replace(/</g,"&lt;").replace(/>/g,"&gt;");t("message",{from:v,color:g,mod:d,sub:h,turbo:r,streamer:v.toLowerCase()===c.toLowerCase(),
action:f,text:e,emotes:n})}else if("PRIVMSG"===d[1])t("host",d[3].substring(1));else if("NOTICE"===d[2])d.splice(0,4),g=d.join(" ").substring(1),t("notice",g);else if("JOIN"===d[1])g=d[0].split("!")[0].substring(1),t("join",g);else if("PART"===d[1])g=d[0].split("!")[0].substring(1),t("part",g);else if("ROOMSTATE"===d[2]){n=d[0].substring(1).split(";");v=r=h=d=g=void 0;for(v in n)n=v.split("="),"broadcaster-lang"===n[0]?g=n[1]:"r9k"===n[0]?d=n[1]:"slow"===n[0]?h=n[1]:"subs-only"===n[0]&&(r=n[1]);t("roomstate",
{lang:g,r9k:d,slow:h,subs_only:r})}else if("WHISPER"===d[2]){g=d;d="#d2691e";h="";r=!1;f=e=n=v="";l=g[0].split(";");for(p=0;p<l.length;p++){l[p]=l[p].split("=");var m=l[p][0],q=l[p][1];"display-name"===m?v=""===q?g[1].split("!")[0].substring(1):q:"@color"===m&&""!=q?d=q:"turbo"===m&&"1"==q?r=!0:"emotes"===m&&""!=q?h=q:"message-id"===m&&""!=q?n=q:"thread-id"===m&&""!=q?e=q:"user-id"===m&&""!=q&&(f=q)}l=g.slice(4).join(" ").substring(1);t("whisper",{from:v,to:g[3],color:d,emotes:h,turbo:r,message_id:n,
thread_id:e,user_id:f,text:l})}else if("CLEARCHAT"===d[1])4===d.length?(g=d[3].substring(1),t("clearUser",g)):t("clearChat");else if("USERSTATE"===d[2])for(d in g=d[0].substring(1).split(";"),d=void 0,g)h=g[d].split("="),"color"===h[0]?Y=h[1]:"display-name"===h[0]?X=h[1]:"emote-sets"===h[0]?Z=h[1]:"mod"===h[0]?T=h[1]:"subscriber"===h[0]?U=h[1]:"turbo"===h[0]?V=h[1]:"user-type"===h[0]&&(W=h[1])}}}I&&E||console.error("TWAPI not set up, cannot run chat.");k&&b.closeChat();c=a.toLowerCase();k=u?new (require("ws"))("ws://irc-ws.chat.twitch.tv:80"):
new WebSocket("ws://irc-ws.chat.twitch.tv:80");u?(k.on("open",e),k.on("message",f)):(k.onopen=e,k.onmessage=f);aa(function(){C();r&&setTimeout(r,500)})};b.closeChat=function(){if(!k)return console.error("Chat is not open.");k.close();console.log("Chat closed.");k=c="";y=!1;S=L=K=J=F=G=N=M=B=A="";z={};H=[];W=V=U=T=Z=Y=X=R=Q=P=O=""};b.changeChannel=function(a){if(!k)return console.error("Chat is not open.");k.send("PART #"+c);c=a;y=!1;S=L=K=J=F=G=N=M=B=A="";z={};H=[];W=V=U=T=R=Q=P=O="";k.send("JOIN #"+
c)};b.sendChat=function(a){if(!k)return console.error("Chat is not open.");k.send("PRIVMSG #"+c+" :"+a)};b.sendWhisper=function(a,b){if(!k)return console.error("Chat is not open.");k.send("PRIVMSG #jtv :/w "+a+" "+b)};b.getUsername=function(){return I};b.getChannel=function(){return c};b.isOnline=function(){return c?y:console.error("Not in a channel.")};b.getStatus=function(){return c?B:console.error("Not in a channel.")};b.getGame=function(){return c?A:console.error("Not in a channel.")};b.getFollowerCount=
function(){return c?M:console.error("Not in a channel.")};b.getTotalViewCount=function(){return c?N:console.error("Not in a channel.")};b.isPartner=function(){return c?G:console.error("Not in a channel.")};b.getCurrentViewCount=function(){return c?F:console.error("Not in a channel.")};b.getFps=function(){return y?J:console.error("Stream not online.")};b.getVideoHeight=function(){return y?K:console.error("Stream not online.")};b.getDelay=function(){return y?L:console.error("Stream not online.")};b.getSubBadgeUrl=
function(){return c?S:console.error("Not in a channel.")};b.getChatters=function(){return c?z:console.error("Not in a channel.")};b.getCreatedAt=function(){return c?O:console.error("Not in a channel.")};b.getLogo=function(){return c?P:console.error("Not in a channel.")};b.getVideoBanner=function(){return c?Q:console.error("Not in a channel.")};b.getProfileBanner=function(){return c?R:console.error("Not in a channel.")};b.getDisplayName=function(){return c?X:console.error("Not in a channel.")};b.getColor=
function(){return c?Y:console.error("Not in a channel.")};b.getEmoteSets=function(){return c?Z:console.error("Not in a channel.")};b.getMod=function(){return c?T:console.error("Not in a channel.")};b.getSub=function(){return c?U:console.error("Not in a channel.")};b.getTurbo=function(){return c?V:console.error("Not in a channel.")};b.getUserType=function(){return c?W:console.error("Not in a channel.")};b.isFollowing=function(a,b,c){w("https://api.twitch.tv/kraken/users/"+a+"/follows/channels/"+b+
"?api_version=3&client_id="+x,function(a){a.error?c({isFollowing:!1}):c({isFollowing:!0,dateFollowed:(new Date(a.created_at)).toLocaleString()})})};b.isSubscribing=function(a,b,c){w("https://api.twitch.tv/kraken/channels/"+b+"/subscriptions/"+a+"?api_version=3client_id="+x,function(a){a.error?c({isSubscribing:!1}):c({isSubscribing:!0,dateSubscribed:(new Date(a.created_at)).toLocaleString()})})};b.runCommercial=function(a){G||console.error("Not a partner, cannot run a commercial.");c||console.error("Not in a channel.");
a||(a=30);var b="/kraken/channels/"+c+"/commercial?oauth_token="+E,e="https://api.twitch.tv"+b;u?(e={host:"https://api.twitch.tv",path:b,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}},require("https").request(e).write("length="+a).end()):(b=new XMLHttpRequest,b.open("POST",e,!0),b.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),b.send("length="+a))};b.setStatusGame=function(a,b){a||(a=B);b||(b=A);var e="https://api.twitch.tv/kraken/channels/"+
c,e=e+("?channel[status]="+encodeURIComponent(a)),e=e+("&channel[game]="+encodeURIComponent(b)),e=e+("&_method=put&oauth_token="+E);if(u)require("https").get(e,function(a){var b="";a.setEncoding("utf8");a.on("data",function(a){b+=a});a.on("end",function(){if(200<=a.statusCode&&400>a.statusCode){var c=JSON.parse(b);A=c.game;B=c.status}else console.error(b)})}).on("error",function(a){console.error(a.message)});else{var f=new XMLHttpRequest;f.open("GET",e,!0);f.onload=function(){if(200<=f.status&&400>
f.status){var a=JSON.parse(f.responseText);A=a.game;B=a.status}else console.error(f.responseText)};f.onerror=function(){console.error(f.responseText)};f.send()}};b.listen=function(a,b){if(D.has(a)){var c=D.get(a);c.push(b);D.set(a,c)}else D.set(a,[b])};return b}"undefined"!==typeof module&&"undefined"!==typeof module.exports?module.exports=C():"function"===typeof define&&define.amd?define([],function(){return C()}):"undefined"===typeof TWAPI?window.TWAPI=C():console.error("TWAPI already defined.")})();
