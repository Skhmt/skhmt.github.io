(function(l){function N(){function M(){g("https://api.twitch.tv/kraken/streams/"+c+"?client_id="+e+"&api_version=3",function(a){a.stream?(v=!0,A=a.stream.viewers,D=a.stream.average_fps,E=a.stream.video_height,F=a.stream.delay):v=!1});g("https://api.twitch.tv/kraken/channels/"+c+"?client_id="+e+"&api_version=3",function(a){x=a.game;y=a.status;l=a.followers;G=a.views;B=a.partner;H=a.created_at;I=a.logo;J=a.video_banner;K=a.profile_banner});g("https://api.twitch.tv/kraken/channels/"+c+"/follows?client_id="+
e+"&api_version=3&limit=100",function(a){if(a.follows){var b=!0;0<C.length&&(b=!1);for(var d=0;d<a.follows.length;d++){var c=a.follows[d].user.display_name;-1===C.indexOf(c)&&(b||r("twapiFollow",c),C.push(c))}}});g("https://tmi.twitch.tv/group/user/"+c+"/chatters?client_id="+e+"&api_version=3",function(a){if(!a.data.chatters)return console.log("No response for user list.");A=a.data.chatter_count;w.moderators=a.data.chatters.moderators.slice();w.staff=a.data.chatters.staff.slice();w.admins=a.data.chatters.admins.slice();
w.global_mods=a.data.chatters.global_mods.slice();w.viewers=a.data.chatters.viewers.slice()});setTimeout(function(){document.querySelector("#twapiJsonpContainer").innerHTML="";M()},1E4)}function O(a){g("https://api.twitch.tv/kraken/chat/"+c+"/badges?api_version=3",function(b){null!=b.subscriber&&(L=b.subscriber.image);a&&a()})}var b={},e="",u="",z="",c="",m,p,v=!1,x="",y="",l="",G="",B="",A="",D="",E="",F="",L="",w={},C=[],H="",I="",J="",K="";b.setup=function(a,b,c){a&&b||console.error("Invalid parameters. Usage: TWAPI.setup(clientid, oauth, callback);");
e=a;u=b;a=document.createElement("div");a.id="twapiJsonpContainer";a.style.cssText="display:none;";document.querySelectorAll("body")[0].appendChild(a);g("https://api.twitch.tv/kraken?client_id="+e+"&oauth_token="+u+"&api_version=3",function(a){z=a.token.user_name;c&&c(z)})};b.runChat=function(a,q){z&&u||console.error("TWAPI not set up, cannot run chat.");m&&b.closeChat();c=a.toLowerCase();g("https://api.twitch.tv/api/channels/"+c+"/chat_properties?api_version=3",function(a){m=new WebSocket("ws://"+
a.web_socket_servers[Math.floor(Math.random()*a.web_socket_servers.length)]);m.onopen=function(a){m.send("CAP REQ :twitch.tv/tags twitch.tv/commands twitch.tv/membership");m.send("PASS oauth:"+u);m.send("NICK "+z);m.send("JOIN #"+c)};m.onmessage=function(a){a=a.data.split("\r\n");for(var b=0;b<a.length;b++){var d=a[b];if("PING :tmi.twitch.tv"===d)m.send("PONG :tmi.twitch.tv");else if(d){r("twapiRaw",d);var f=d.split(" ");if("PRIVMSG"===f[2]){d=f[0];f.splice(0,1);for(var q=f,e=d.split(";"),d="#d2691e",
p=f=!1,l=!1,g="",k="",n=0;n<e.length;n++){e[n]=e[n].split("=");var t=e[n][0],h=e[n][1];"display-name"===t?g=""===h?q[0].split("!")[0].substring(1):h:"@color"===t&&""!=h?d=h:"mod"===t&&"1"==h?f=!0:"subscriber"===t&&"1"==h?p=!0:"turbo"===t&&"1"==h?l=!0:"emotes"===t&&""!=h&&(k=h)}e=!1;n=q[3].substring(1);q.splice(0,4);q=q.join(" ");"\u0001ACTION"===n?(n=q,e=!0):n+=" "+q;q=n.replace(/</g,"&lt;").replace(/>/g,"&gt;");r("twapiMsg",{from:g,color:d,mod:f,sub:p,turbo:l,streamer:g.toLowerCase()===c.toLowerCase(),
action:e,text:q,emotes:k})}else if("PRIVMSG"===f[1])r("twapiHost",f[3].substring(1));else if("NOTICE"===f[2])f.splice(0,4),d=f.join(" ").substring(1),r("twapiNotice",d);else if("JOIN"===f[1])d=f[0].split("!")[0].substring(1),r("twapiJoin",d);else if("PART"===f[1])d=f[0].split("!")[0].substring(1),r("twapiPart",d);else if("ROOMSTATE"===f[2]){k=f[0].substring(1).split(";");g=l=p=f=d=void 0;for(g in k)k=g.split("="),"broadcaster-lang"===k[0]?d=k[1]:"r9k"===k[0]?f=k[1]:"slow"===k[0]?p=k[1]:"subs-only"===
k[0]&&(l=k[1]);r("twapiRoomstate",{lang:d,r9k:f,slow:p,subs_only:l})}else"CLEARCHAT"===f[1]&&(4===f.length?(d=f[3].substring(1),r("twapiClearUser",d)):r("twapiClearChat"))}}};O(function(){M();q&&setTimeout(q,500)})});p=new WebSocket("ws://group-ws.tmi.twitch.tv");p.onopen=function(a){p.send("CAP REQ :twitch.tv/commands twitch.tv/tags");p.send("PASS oauth:"+u);p.send("NICK "+z)};p.onmessage=function(a){a=a.data.split("\r\n");for(var b=0;b<a.length;b++){var c=a[b];if("PING :tmi.twitch.tv"===c)p.send("PONG :tmi.twitch.tv");
else if(c)if(r("twapiRawGroup",c),c=c.split(" "),"NOTICE"===c[2])r("twapiGroupNotice",c.slice(4).join(" ").substring(1));else if("WHISPER"===c[2]){for(var q="#d2691e",f="",e=!1,m="",g="",l="",u="",k=c[0].split(";"),n=0;n<k.length;n++){k[n]=k[n].split("=");var t=k[n][0],h=k[n][1];"display-name"===t?m=""===h?c[1].split("!")[0].substring(1):h:"@color"===t&&""!=h?q=h:"turbo"===t&&"1"==h?e=!0:"emotes"===t&&""!=h?f=h:"message-id"===t&&""!=h?g=h:"thread-id"===t&&""!=h?l=h:"user-id"===t&&""!=h&&(u=h)}k=c.slice(4).join(" ").substring(1);
r("twapiWhisper",{from:m,to:c[3],color:q,emotes:f,turbo:e,message_id:g,thread_id:l,user_id:u,text:k})}}}};b.closeChat=function(){if(!m)return console.error("Chat is not open.");m.close();p.close();console.log("Chat closed.");p=m=c="";v=!1;L=F=E=D=A=B=G=l=y=x="";w={};C=[];K=J=I=H=""};b.changeChannel=function(a){if(!m)return console.error("Chat is not open.");m.send("PART #"+c);c=a;v=!1;L=F=E=D=A=B=G=l=y=x="";w={};C=[];K=J=I=H="";m.send("JOIN #"+c)};b.sendChat=function(a){if(!m)return console.error("Chat is not open.");
m.send("PRIVMSG #"+c+" :"+a)};b.sendWhisper=function(a,b){if(!p)return console.error("Group chat is not open.");p.send("PRIVMSG #jtv :/w "+a+" "+b)};b.getUsername=function(){return z};b.getChannel=function(){return c};b.isOnline=function(){return c?v:console.error("Not in a channel.")};b.getStatus=function(){return c?y:console.error("Not in a channel.")};b.getGame=function(){return c?x:console.error("Not in a channel.")};b.getFollowerCount=function(){return c?l:console.error("Not in a channel.")};
b.getTotalViewCount=function(){return c?G:console.error("Not in a channel.")};b.isPartner=function(){return c?B:console.error("Not in a channel.")};b.getCurrentViewCount=function(){return c?A:console.error("Not in a channel.")};b.getFps=function(){return v?D:console.error("Stream not online.")};b.getVideoHeight=function(){return v?E:console.error("Stream not online.")};b.getDelay=function(){return v?F:console.error("Stream not online.")};b.getSubBadgeUrl=function(){return c?L:console.error("Not in a channel.")};
b.getChatters=function(){return c?w:console.error("Not in a channel.")};b.getCreatedAt=function(){return c?H:console.error("Not in a channel.")};b.getLogo=function(){return c?I:console.error("Not in a channel.")};b.getVideoBanner=function(){return c?J:console.error("Not in a channel.")};b.getProfileBanner=function(){return c?K:console.error("Not in a channel.")};b.isFollowing=function(a,b,c){g("https://api.twitch.tv/kraken/users/"+a+"/follows/channels/"+b+"?api_version=3&client_id="+e,function(a){a.error?
c({isFollowing:!1}):c({isFollowing:!0,dateFollowed:(new Date(a.created_at)).toLocaleString()})})};b.isSubscribing=function(a,b,c){g("https://api.twitch.tv/kraken/channels/"+b+"/subscriptions/"+a+"?api_version=3client_id="+e,function(a){a.error?c({isSubscribing:!1}):c({isSubscribing:!0,dateSubscribed:(new Date(a.created_at)).toLocaleString()})})};b.runCommercial=function(a){B||console.error("Not a partner, cannot run a commercial.");c||console.error("Not in a channel.");a||(a=30);var b="https://api.twitch.tv/kraken/channels/"+
c+"/commercial",b=b+("?oauth_token="+u),d=new XMLHttpRequest;d.open("POST",b,!0);d.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8");d.send("length="+a)};b.setStatusGame=function(a,b){a||(a=y);b||(b=x);var d="https://api.twitch.tv/kraken/channels/"+c,d=d+("?channel[status]="+encodeURIComponent(a)),d=d+("&channel[game]="+encodeURIComponent(b)),d=d+("&_method=put&oauth_token="+u),e=new XMLHttpRequest;e.open("GET",d,!0);e.onload=function(){if(200<=e.status&&400>e.status){var a=
JSON.parse(e.responseText);x=a.game;y=a.status}else console.error(e.responseText)};e.onerror=function(){console.error(e.responseText)};e.send()};return b}function r(g,l){var b=new CustomEvent(g,{detail:l});document.dispatchEvent(b)}function g(g,r){var b;do b="jsonp"+Math.floor(1E6*Math.random());while(l[b]);l[b]=function(e){r(e);delete l[b]};var e=document.createElement("script");e.src=g+"&callback="+b;document.querySelector("#twapiJsonpContainer").appendChild(e)}"undefined"===typeof TWAPI?l.TWAPI=
N():console.error("TWAPI already defined.")})(window);
