(function(){function A(){function A(){k("https://api.twitch.tv/kraken/streams/"+e+"?client_id="+l+"&api_version=3",function(a){a.stream?(w=!0,D=a.stream.viewers,H=a.stream.average_fps,I=a.stream.video_height,J=a.stream.delay):w=!1});k("https://api.twitch.tv/kraken/channels/"+e+"?client_id="+l+"&api_version=3",function(a){y=a.game;z=a.status;K=a.followers;L=a.views;E=a.partner;M=a.created_at;N=a.logo;O=a.video_banner;P=a.profile_banner});k("https://api.twitch.tv/kraken/channels/"+e+"/follows?client_id="+
l+"&api_version=3&limit=100",function(a){if(a.follows){var d=!0;0<F.length&&(d=!1);for(var c=0;c<a.follows.length;c++){var b=a.follows[c].user.display_name;-1===F.indexOf(b)&&(d||r("follow",b),F.push(b))}}});k("https://tmi.twitch.tv/group/user/"+e+"/chatters?client_id="+l+"&api_version=3",function(a){u||(a=a.data);if(!a.chatters)return console.log("No response for user list.");D=a.chatter_count;x.moderators=a.chatters.moderators.slice();x.staff=a.chatters.staff.slice();x.admins=a.chatters.admins.slice();
x.global_mods=a.chatters.global_mods.slice();x.viewers=a.chatters.viewers.slice()});setTimeout(function(){u||(document.querySelector("#twapiJsonpContainer").innerHTML="");A()},1E4)}function R(a){k("https://api.twitch.tv/kraken/chat/"+e+"/badges?api_version=3",function(d){null!=d.subscriber&&(Q=d.subscriber.image);a&&a()})}function r(a,d){if(B.has(a)){var c=B.get(a),b;for(b in c)c[b](d)}}function k(a,b){if(u)require("https").get(a,function(a){var c="";a.setEncoding("utf8");a.on("data",function(a){c+=
a});a.on("end",function(){200<=a.statusCode&&400>a.statusCode?b(JSON.parse(c)):console.error(c)})}).on("error",function(a){console.error(a.message)});else{var c;do c="jsonp"+Math.floor(1E6*Math.random());while(window[c]);window[c]=function(a){b(a);delete window[c]};var e=document.createElement("script");e.src=a+"&callback="+c;document.querySelector("#twapiJsonpContainer").appendChild(e)}}var b={},l="",C="",G="",e="",g,w=!1,y="",z="",K="",L="",E="",D="",H="",I="",J="",Q="",x={},F=[],M="",N="",O="",
P="",u=!1,B=new Map;"undefined"!==typeof module&&"undefined"!==typeof module.exports&&(u=!0,console.info("TWAPI is running in Node.js."));b.setup=function(a,b,c){a&&b||console.error("Invalid parameters. Usage: TWAPI.setup(clientid, oauth, callback);");l=a;C=b;u||(a=document.createElement("div"),a.id="twapiJsonpContainer",a.style.cssText="display:none;",document.getElementsByTagName("body")[0].appendChild(a));k("https://api.twitch.tv/kraken?client_id="+l+"&oauth_token="+C+"&api_version=3",function(a){G=
a.token.user_name;c&&c(G)})};b.runChat=function(a,d){function c(){g.send("CAP REQ :twitch.tv/tags twitch.tv/commands twitch.tv/membership");g.send("PASS oauth:"+C);g.send("NICK "+G);g.send("JOIN #"+e)}function f(a){a=u?a.split("\r\n"):a.data.split("\r\n");for(var c=0;c<a.length;c++){var b=a[c];if("PING :tmi.twitch.tv"===b)g.send("PONG :tmi.twitch.tv");else if(b){r("raw",b);var d=b.split(" ");if("PRIVMSG"===d[2]){b=d[0];d.splice(0,1);for(var f=d,t=b.split(";"),b="#d2691e",k=d=!1,l=!1,v="",n="",h=0;h<
t.length;h++){t[h]=t[h].split("=");var p=t[h][0],m=t[h][1];"display-name"===p?v=""===m?f[0].split("!")[0].substring(1):m:"@color"===p&&""!=m?b=m:"mod"===p&&"1"==m?d=!0:"subscriber"===p&&"1"==m?k=!0:"turbo"===p&&"1"==m?l=!0:"emotes"===p&&""!=m&&(n=m)}t=!1;h=f[3].substring(1);f.splice(0,4);f=f.join(" ");"\u0001ACTION"===h?(h=f,t=!0):h+=" "+f;f=h.replace(/</g,"&lt;").replace(/>/g,"&gt;");r("message",{from:v,color:b,mod:d,sub:k,turbo:l,streamer:v.toLowerCase()===e.toLowerCase(),action:t,text:f,emotes:n})}else if("PRIVMSG"===
d[1])r("host",d[3].substring(1));else if("NOTICE"===d[2])d.splice(0,4),b=d.join(" ").substring(1),r("notice",b);else if("JOIN"===d[1])b=d[0].split("!")[0].substring(1),r("join",b);else if("PART"===d[1])b=d[0].split("!")[0].substring(1),r("part",b);else if("ROOMSTATE"===d[2]){n=d[0].substring(1).split(";");v=l=k=d=b=void 0;for(v in n)n=v.split("="),"broadcaster-lang"===n[0]?b=n[1]:"r9k"===n[0]?d=n[1]:"slow"===n[0]?k=n[1]:"subs-only"===n[0]&&(l=n[1]);r("roomstate",{lang:b,r9k:d,slow:k,subs_only:l})}else if("WHISPER"===
d[2]){b=d;d="#d2691e";k="";l=!1;t=f=n=v="";h=b[0].split(";");for(p=0;p<h.length;p++){h[p]=h[p].split("=");var m=h[p][0],q=h[p][1];"display-name"===m?v=""===q?b[1].split("!")[0].substring(1):q:"@color"===m&&""!=q?d=q:"turbo"===m&&"1"==q?l=!0:"emotes"===m&&""!=q?k=q:"message-id"===m&&""!=q?n=q:"thread-id"===m&&""!=q?f=q:"user-id"===m&&""!=q&&(t=q)}h=b.slice(4).join(" ").substring(1);r("whisper",{from:v,to:b[3],color:d,emotes:k,turbo:l,message_id:n,thread_id:f,user_id:t,text:h})}else"CLEARCHAT"===d[1]&&
(4===d.length?(b=d[3].substring(1),r("clearUser",b)):r("clearChat"))}}}G&&C||console.error("TWAPI not set up, cannot run chat.");g&&b.closeChat();e=a.toLowerCase();g=u?new (require("ws"))("ws://irc-ws.chat.twitch.tv:80"):new WebSocket("ws://irc-ws.chat.twitch.tv:80");u?(g.on("open",c),g.on("message",f)):(g.onopen=c,g.onmessage=f);R(function(){A();d&&setTimeout(d,500)})};b.closeChat=function(){if(!g)return console.error("Chat is not open.");g.close();console.log("Chat closed.");g=e="";w=!1;Q=J=I=H=
D=E=L=K=z=y="";x={};F=[];P=O=N=M=""};b.changeChannel=function(a){if(!g)return console.error("Chat is not open.");g.send("PART #"+e);e=a;w=!1;Q=J=I=H=D=E=L=K=z=y="";x={};F=[];P=O=N=M="";g.send("JOIN #"+e)};b.sendChat=function(a){if(!g)return console.error("Chat is not open.");g.send("PRIVMSG #"+e+" :"+a)};b.sendWhisper=function(a,b){if(!g)return console.error("Chat is not open.");g.send("PRIVMSG #jtv :/w "+a+" "+b)};b.getUsername=function(){return G};b.getChannel=function(){return e};b.isOnline=function(){return e?
w:console.error("Not in a channel.")};b.getStatus=function(){return e?z:console.error("Not in a channel.")};b.getGame=function(){return e?y:console.error("Not in a channel.")};b.getFollowerCount=function(){return e?K:console.error("Not in a channel.")};b.getTotalViewCount=function(){return e?L:console.error("Not in a channel.")};b.isPartner=function(){return e?E:console.error("Not in a channel.")};b.getCurrentViewCount=function(){return e?D:console.error("Not in a channel.")};b.getFps=function(){return w?
H:console.error("Stream not online.")};b.getVideoHeight=function(){return w?I:console.error("Stream not online.")};b.getDelay=function(){return w?J:console.error("Stream not online.")};b.getSubBadgeUrl=function(){return e?Q:console.error("Not in a channel.")};b.getChatters=function(){return e?x:console.error("Not in a channel.")};b.getCreatedAt=function(){return e?M:console.error("Not in a channel.")};b.getLogo=function(){return e?N:console.error("Not in a channel.")};b.getVideoBanner=function(){return e?
O:console.error("Not in a channel.")};b.getProfileBanner=function(){return e?P:console.error("Not in a channel.")};b.isFollowing=function(a,b,c){k("https://api.twitch.tv/kraken/users/"+a+"/follows/channels/"+b+"?api_version=3&client_id="+l,function(a){a.error?c({isFollowing:!1}):c({isFollowing:!0,dateFollowed:(new Date(a.created_at)).toLocaleString()})})};b.isSubscribing=function(a,b,c){k("https://api.twitch.tv/kraken/channels/"+b+"/subscriptions/"+a+"?api_version=3client_id="+l,function(a){a.error?
c({isSubscribing:!1}):c({isSubscribing:!0,dateSubscribed:(new Date(a.created_at)).toLocaleString()})})};b.runCommercial=function(a){E||console.error("Not a partner, cannot run a commercial.");e||console.error("Not in a channel.");a||(a=30);var b="/kraken/channels/"+e+"/commercial?oauth_token="+C,c="https://api.twitch.tv"+b;u?(c={host:"https://api.twitch.tv",path:b,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}},require("https").request(c).write("length="+
a).end()):(b=new XMLHttpRequest,b.open("POST",c,!0),b.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),b.send("length="+a))};b.setStatusGame=function(a,b){a||(a=z);b||(b=y);var c="https://api.twitch.tv/kraken/channels/"+e,c=c+("?channel[status]="+encodeURIComponent(a)),c=c+("&channel[game]="+encodeURIComponent(b)),c=c+("&_method=put&oauth_token="+C);if(u)require("https").get(c,function(a){var b="";a.setEncoding("utf8");a.on("data",function(a){b+=a});a.on("end",function(){if(200<=
a.statusCode&&400>a.statusCode){var c=JSON.parse(b);y=c.game;z=c.status}else console.error(b)})}).on("error",function(a){console.error(a.message)});else{var f=new XMLHttpRequest;f.open("GET",c,!0);f.onload=function(){if(200<=f.status&&400>f.status){var a=JSON.parse(f.responseText);y=a.game;z=a.status}else console.error(f.responseText)};f.onerror=function(){console.error(f.responseText)};f.send()}};b.listen=function(a,b){if(B.has(a)){var c=B.get(a);c.push(b);B.set(a,c)}else B.set(a,[b])};return b}
"undefined"!==typeof module&&"undefined"!==typeof module.exports?module.exports=A():"function"===typeof define&&define.amd?define([],function(){return A()}):"undefined"===typeof TWAPI?window.TWAPI=A():console.error("TWAPI already defined.")})();
