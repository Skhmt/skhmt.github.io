/**
 * @title TAPIC.js
 * @overview Twitch API & Chat in javascript.
 * @author Skhmt
 * @license MIT
 * @version 3.0.0
 */

 (function(){function v(){function m(d){var a=new Map;d=d.substring(1).split(";");for(var f=0;f<d.length;f++){var e=d[f].split("=");a.set(e[0],e[1])}return a}function t(d){e&&(l("https://api.twitch.tv/kraken/streams/"+e+"?client_id="+h+"&api_version=3",function(a){a.stream?(p=!0,A=a.stream.viewers,F=a.stream.average_fps,G=a.stream.video_height,H=a.stream.delay):p=!1}),l("https://api.twitch.tv/kraken/channels/"+e+"?client_id="+h+"&api_version=3",function(a){w=a.game;x=a.status;I=a.followers;J=a.views;
 B=a.partner;K=a.created_at;L=a.logo;M=a.video_banner;N=a.profile_banner}),l("https://api.twitch.tv/kraken/channels/"+e+"/follows?client_id="+h+"&api_version=3&limit=100",function(a){if(a.follows){var d=!0;0<C.length&&(d=!1);for(var e=0;e<a.follows.length;e++){var b=a.follows[e].user.display_name;-1===C.indexOf(b)&&(d||g("follow",b),C.push(b))}}}),l("https://tmi.twitch.tv/group/user/"+e+"/chatters?client_id="+h+"&api_version=3",function(a){n||(a=a.data);if(!a.chatters)return console.log("No response for user list.");
 A=a.chatter_count;q.moderators=a.chatters.moderators.slice();q.staff=a.chatters.staff.slice();q.admins=a.chatters.admins.slice();q.global_mods=a.chatters.global_mods.slice();q.viewers=a.chatters.viewers.slice()}));setTimeout(function(){n||(document.getElementById("tapicJsonpContainer").innerHTML="");t(d)},1E3*d)}function r(d){if("function"!==typeof d)return console.error("Callback needed.");l("https://api.twitch.tv/kraken/chat/"+e+"/badges?api_version=3&client_id="+h,function(a){a.subscriber&&(O=
 a.subscriber.image);d&&d()})}function l(d,a){if("function"!==typeof a)return console.error("Callback needed.");if(n)require("https").get(d,function(d){var e="";d.setEncoding("utf8");d.on("data",function(a){e+=a});d.on("end",function(){200<=d.statusCode&&400>d.statusCode?a(JSON.parse(e)):console.error(e)})}).on("error",function(a){console.error(a.message)});else{var e;do e="tapicJSONP"+Math.floor(1E6*Math.random());while(window[e]);window[e]=function(d){a(d);delete window[e]};var b=document.createElement("script");
 b.src=d+"&callback="+e;document.getElementById("tapicJsonpContainer").appendChild(b)}}function g(d,a){if(u.has(d))for(var e=u.get(d),b=0;b<e.length;b++)e[b](a)}var b={},h="",y="",E="",k,n=!1,u=new Map,e="",p=!1,w="",x="",I="",J="",B="",A="",F="",G="",H="",O="",q={},C=[],K="",L="",M="",N="",v="",T="",U="",P="",Q="",R="",S="";"undefined"!==typeof module&&"undefined"!==typeof module.exports&&(n=!0);b.setup=function(d,a,b){"string"!=typeof d||"string"!=typeof a?console.error("Invalid parameters. Usage: TAPIC.setup(clientid, oauth[, callback]);"):
 (h=d,y=a.replace("oauth:",""),n||(d=document.createElement("div"),d.id="tapicJsonpContainer",d.style.cssText="display:none;",document.getElementsByTagName("body")[0].appendChild(d)),l("https://api.twitch.tv/kraken?client_id="+h+"&oauth_token="+y+"&api_version=3",function(a){function d(){k.send("CAP REQ :twitch.tv/tags twitch.tv/commands twitch.tv/membership");k.send("PASS oauth:"+y);k.send("NICK "+E)}function h(a){a=n?a.split("\r\n"):a.data.split("\r\n");for(var d=0;d<a.length;d++){var c=a[d];if("PING :tmi.twitch.tv"===
 c)k.send("PONG :tmi.twitch.tv");else if(c)if(g("raw",c),c=c.split(" "),"PRIVMSG"===c[2]){var b=c,c=m(b[0]);c.get("display-name")||c.set("display-name",b[1].split("!")[0].substring(1));c.get("color")||c.set("color","#d2691e");c.set("badges",c.get("badges").split(","));var f=!1,b=b.slice(4);b[0]=b[0].substring(1);"ACTION"===b[0]&&(b=b.slice(1),f=!0);var z=b.join(" ").replace(/</g,"&lt;").replace(/>/g,"&gt;");"twitchnotify"===c.get("display-name")?"just"===b[1]?g("sub",b[0]):g("subsAway",b[0]):g("message",
 {from:c.get("display-name"),color:c.get("color"),mod:1==c.get("mod"),sub:1==c.get("subscriber"),turbo:1==c.get("turbo"),streamer:c.get("display-name").toLowerCase()===e.toLowerCase(),action:f,text:z,emotes:c.get("emotes"),badges:c.get("badges"),room_id:c.get("room-id"),user_id:c.get("user-id")})}else if("PRIVMSG"===c[1])g("host",c[3].substring(1));else if("NOTICE"===c[2])c.splice(0,4),c=c.join(" ").substring(1),g("notice",c);else if("JOIN"===c[1])c=c[0].split("!")[0].substring(1),g("join",c);else if("PART"===
 c[1])c=c[0].split("!")[0].substring(1),g("part",c);else if("ROOMSTATE"===c[2])c=m(c[0]),g("roomstate",{lang:c.get("broadcaster-lang"),r9k:c.get("r9k"),slow:c.get("slow"),subs_only:c.get("subs-only")});else if("WHISPER"===c[2])f=m(c[0]),f.get("display-name")||f.set("display-name",c[1].split("!")[0].substring(1)),f.get("color")||f.set("color","#d2691e"),f.set("badges",f.get("badges").split(",")),b=c.slice(4).join(" ").substring(1),g("whisper",{from:f.get("display-name"),to:c[3],color:f.get("color"),
 emotes:f.get("emotes"),turbo:f.get("turbo"),message_id:f.get("message-id"),thread_id:f.get("thread-id"),user_id:f.get("user-id"),text:b,badges:f.get("badges")});else if("CLEARCHAT"===c[1])g("clearChat");else if("CLEARCHAT"===c[2]){for(var z=c[0].slice(1).split(";"),f="",b=1,l=0;l<z.length;l++){var D=z[l].split("=");"ban-duration"===D[0]?b=D[1]:"ban-reason"===D[0]&&(f=D[1].replace(/\\s/g," "))}c=c[4].slice(1);g("clearUser",{name:c,reason:f,duration:b})}else"USERSTATE"===c[2]?(c=m(c[0]),T=c.get("color"),
 v=c.get("display-name"),U=c.get("emote-sets"),P=c.get("mod"),Q=c.get("subscriber"),R=c.get("turbo"),S=c.get("user-type")):"USERNOTICE"===c[2]&&(f=m(c[0]),c=c.slice(4).join(" ").substring(1),g("subMonths",{name:f.get("display-name"),months:f.get("msg-param-months"),message:c}))}}E=a.token.user_name;k=n?new (require("ws"))("wss://irc-ws.chat.twitch.tv:443"):new WebSocket("wss://irc-ws.chat.twitch.tv:443");n?(k.on("open",d),k.on("message",h)):(k.onopen=d,k.onmessage=h);r(function(){t(5);"function"==
 typeof b&&setTimeout(function(){b(E)},500)})}))};b.joinChannel=function(d){if("string"!=typeof d)console.error("Invalid parameters. Usage: TAPIC.joinChannel(channel);");else{if(!k)return console.error("Tapic not setup.");e&&k.send("PART #"+e);e=d.replace("#","");p=!1;O=H=G=F=A=B=J=I=x=w="";q={};C=[];S=R=Q=P=N=M=L=K="";k.send("JOIN #"+e)}};b.sendChat=function(d){if("string"!=typeof d)console.error("Invalid parameters. Usage: TAPIC.sendChat(message);");else{if(!k)return console.error("Tapic not setup.");
 k.send("PRIVMSG #"+e+" :"+d);g("echoChat",d)}};b.sendWhisper=function(d,a){if("string"!=typeof d||"string"!=typeof a)console.error("Invalid parameters. Usage: TAPIC.sendWhisper(user, message);");else{if(!k)return console.error("Tapic not setup.");k.send("PRIVMSG #jtv :/w "+d+" "+a);g("echoWhisper",{to:d,text:a})}};b.getUsername=function(){return E};b.getChannel=function(){return e};b.isOnline=function(){return e?p:console.error("Not in a channel.")};b.getStatus=function(){return e?x:console.error("Not in a channel.")};
 b.getGame=function(){return e?w:console.error("Not in a channel.")};b.getFollowerCount=function(){return e?I:console.error("Not in a channel.")};b.getTotalViewCount=function(){return e?J:console.error("Not in a channel.")};b.isPartner=function(){return e?B:console.error("Not in a channel.")};b.getCurrentViewCount=function(){return e?A:console.error("Not in a channel.")};b.getFps=function(){return p?F:console.error("Stream not online.")};b.getVideoHeight=function(){return p?G:console.error("Stream not online.")};
 b.getDelay=function(){return p?H:console.error("Stream not online.")};b.getSubBadgeUrl=function(){return e?O:console.error("Not in a channel.")};b.getChatters=function(){return e?q:console.error("Not in a channel.")};b.getCreatedAt=function(){return e?K:console.error("Not in a channel.")};b.getLogo=function(){return e?L:console.error("Not in a channel.")};b.getVideoBanner=function(){return e?M:console.error("Not in a channel.")};b.getProfileBanner=function(){return e?N:console.error("Not in a channel.")};
 b.getDisplayName=function(){return e?v:console.error("Not in a channel.")};b.getColor=function(){return e?T:console.error("Not in a channel.")};b.getEmoteSets=function(){return e?U:console.error("Not in a channel.")};b.getMod=function(){return e?1==P:console.error("Not in a channel.")};b.getSub=function(){return e?1==Q:console.error("Not in a channel.")};b.getTurbo=function(){return e?1==R:console.error("Not in a channel.")};b.getUserType=function(){return e?S:console.error("Not in a channel.")};
 b.isFollowing=function(d,a,b){"string"!=typeof d||"string"!=typeof a||"function"!=typeof b?console.error("Invalid parameters. Usage: TAPIC.isFollowing(user, channel, callback);"):l("https://api.twitch.tv/kraken/users/"+d+"/follows/channels/"+a+"?api_version=3&client_id="+h,function(a){a.error?b({isFollowing:!1}):b({isFollowing:!0,dateFollowed:(new Date(a.created_at)).toLocaleString()})})};b.isSubscribing=function(d,a,b){"string"!=typeof d||"function"!=typeof b?console.error("Invalid parameters. Usage: TAPIC.isSubscribing(user, callback);"):
 l("https://api.twitch.tv/kraken/channels/"+e+"/subscriptions/"+d+"?api_version=3client_id="+h,function(a){a.error?b({isSubscribing:!1}):b({isSubscribing:!0,dateSubscribed:(new Date(a.created_at)).toLocaleString()})})};b.runCommercial=function(b){if("number"!=typeof b)console.error("Invalid parameters. Usage: TAPIC.runCommercial(length);");else{if(!B)return console.error("Not a partner, cannot run a commercial.");if(!e)return console.error("Not in a channel.");var a="/kraken/channels/"+e+"/commercial?oauth_token="+
 y,f="https://api.twitch.tv"+a;n?(f={host:"https://api.twitch.tv",path:a,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","Client-ID":h}},require("https").request(f).write("length="+b).end()):(a=new XMLHttpRequest,a.open("POST",f,!0),a.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),a.setRequestHeader("Client-ID",h),a.send("length="+b))}};b.setStatusGame=function(b,a){if("string"!=typeof b||"string"!=typeof a)console.error("Invalid parameters. Usage: TAPIC.setStatusGame(status, game);");
 else{var f="/kraken/channels/"+e,f=f+("?channel[status]="+encodeURIComponent(b)),f=f+("&channel[game]="+encodeURIComponent(a)),f=f+("&_method=put&oauth_token="+y);if(n)f={host:"https://api.twitch.tv",path:f,headers:{"Client-ID":h}},require("https").get(f,function(a){var b="";a.setEncoding("utf8");a.on("data",function(a){b+=a});a.on("end",function(){if(200<=a.statusCode&&400>a.statusCode){var d=JSON.parse(b);w=d.game;x=d.status}else console.error(b)})}).on("error",function(a){console.error(a.message)});
 else{var g=new XMLHttpRequest;g.open("GET","https://api.twitch.tv"+f,!0);g.setRequestHeader("Client-ID",h);g.onload=function(){if(200<=g.status&&400>g.status){var a=JSON.parse(g.responseText);w=a.game;x=a.status}else console.error(g.responseText)};g.onerror=function(){console.error(g.responseText)};g.send()}}};b.listen=function(b,a){if("string"!=typeof b)console.error("Invalid parameters. Usage: TAPIC.listen(eventName[, callback]);");else{if("function"!==typeof a)return console.error("Callback needed.");
 if(u.has(b)){var e=u.get(b);e.push(a);u.set(b,e)}else u.set(b,[a])}};b.emit=function(b,a){"string"!=typeof b||"string"!=typeof a?console.error("Invalid parameters. Usage: TAPIC.emit(eventName, eventDetail);"):g(b,a)};return b}"function"!==typeof Map&&(window.Map=function(){var m=Object.create(null),t={size:0,get:function(r){return m[r]},set:function(r,l){m[r]=l;t.size++},has:function(r){return!!m[r]},clear:function(){m=Object.create(null);t.size=0}};return t});"undefined"!==typeof module&&"undefined"!==
 typeof module.exports?module.exports=v():"undefined"===typeof TAPIC?window.TAPIC=v():console.error("TAPIC already defined.")})();
