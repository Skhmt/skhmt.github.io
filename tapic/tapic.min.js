(function(){function D(){function D(){w("https://api.twitch.tv/kraken/streams/"+d+"?client_id="+k+"&api_version=3",function(a){a.stream?(x=!0,E=a.stream.viewers,I=a.stream.average_fps,J=a.stream.video_height,K=a.stream.delay):x=!1});w("https://api.twitch.tv/kraken/channels/"+d+"?client_id="+k+"&api_version=3",function(a){z=a.game;A=a.status;L=a.followers;M=a.views;F=a.partner;N=a.created_at;O=a.logo;P=a.video_banner;Q=a.profile_banner});w("https://api.twitch.tv/kraken/channels/"+d+"/follows?client_id="+
k+"&api_version=3&limit=100",function(a){if(a.follows){var b=!0;0<G.length&&(b=!1);for(var c=0;c<a.follows.length;c++){var d=a.follows[c].user.display_name;-1===G.indexOf(d)&&(b||p("follow",d),G.push(d))}}});w("https://tmi.twitch.tv/group/user/"+d+"/chatters?client_id="+k+"&api_version=3",function(a){t||(a=a.data);if(!a.chatters)return console.log("No response for user list.");E=a.chatter_count;y.moderators=a.chatters.moderators.slice();y.staff=a.chatters.staff.slice();y.admins=a.chatters.admins.slice();
y.global_mods=a.chatters.global_mods.slice();y.viewers=a.chatters.viewers.slice()});setTimeout(function(){t||(document.querySelector("#tapicJsonpContainer").innerHTML="");D()},1E4)}function Z(a){w("https://api.twitch.tv/kraken/chat/"+d+"/badges?api_version=3&client_id="+k,function(d){d.subscriber&&(R=d.subscriber.image);a&&a()})}function w(a,d){if(t)require("https").get(a,function(a){var b="";a.setEncoding("utf8");a.on("data",function(a){b+=a});a.on("end",function(){200<=a.statusCode&&400>a.statusCode?
d(JSON.parse(b)):console.error(b)})}).on("error",function(a){console.error(a.message)});else{var c;do c="jsonp"+Math.floor(1E6*Math.random());while(window[c]);window[c]=function(a){d(a);delete window[c]};var b=document.createElement("script");b.src=a+"&callback="+c;document.querySelector("#tapicJsonpContainer").appendChild(b)}}function p(a,b){if(B.has(a))for(var d=B.get(a),f=0;f<d.length;f++)d[f](b)}var b={},k="",C="",H="",d="",l,x=!1,z="",A="",L="",M="",F="",E="",I="",J="",K="",R="",y={},G=[],N=
"",O="",P="",Q="",t=!1,B=new Map,W="",X="",Y="",S="",T="",U="",V="";"undefined"!==typeof module&&"undefined"!==typeof module.exports&&(t=!0);b.setup=function(a,d,b){a&&d?(k=a,C=d,t||(a=document.createElement("div"),a.id="tapicJsonpContainer",a.style.cssText="display:none;",document.getElementsByTagName("body")[0].appendChild(a)),w("https://api.twitch.tv/kraken?client_id="+k+"&oauth_token="+C+"&api_version=3",function(a){H=a.token.user_name;b&&b(H)})):console.error("Invalid parameters. Usage: TAPIC.setup(clientid, oauth[, callback]);")};
b.runChat=function(a,g){function c(){l.send("CAP REQ :twitch.tv/tags twitch.tv/commands twitch.tv/membership");l.send("PASS oauth:"+C);l.send("NICK "+H);l.send("JOIN #"+d)}function f(a){a=t?a.split("\r\n"):a.data.split("\r\n");for(var b=0;b<a.length;b++){var c=a[b];if("PING :tmi.twitch.tv"===c)l.send("PONG :tmi.twitch.tv");else if(c){p("raw",c);var e=c.split(" ");if("PRIVMSG"===e[2]){c=e[0];e.splice(0,1);for(var g=e,f=c.split(";"),c="#d2691e",h=e=!1,k=!1,u="",v="",m=0;m<f.length;m++){f[m]=f[m].split("=");
var q=f[m][0],n=f[m][1];"display-name"===q?u=""===n?g[0].split("!")[0].substring(1):n:"@color"===q&&""!==n?c=n:"mod"===q&&"1"==n?e=!0:"subscriber"===q&&"1"==n?h=!0:"turbo"===q&&"1"==n?k=!0:"emotes"===q&&""!==n&&(v=n)}f=!1;m=g[3].substring(1);g.splice(0,4);g=g.join(" ");"\u0001ACTION"===m?(m=g,f=!0):m+=" "+g;g=m.replace(/</g,"&lt;").replace(/>/g,"&gt;");p("message",{from:u,color:c,mod:e,sub:h,turbo:k,streamer:u.toLowerCase()===d.toLowerCase(),action:f,text:g,emotes:v})}else if("PRIVMSG"===e[1])p("host",
e[3].substring(1));else if("NOTICE"===e[2])e.splice(0,4),c=e.join(" ").substring(1),p("notice",c);else if("JOIN"===e[1])c=e[0].split("!")[0].substring(1),p("join",c);else if("PART"===e[1])c=e[0].split("!")[0].substring(1),p("part",c);else if("ROOMSTATE"===e[2]){c=e[0].substring(1).split(";");u=k=h=e=void 0;for(v=0;v<c.length;v++)g=c[v].split("="),"broadcaster-lang"===g[0]?e=g[1]:"r9k"===g[0]?h=g[1]:"slow"===g[0]?k=g[1]:"subs-only"===g[0]&&(u=g[1]);p("roomstate",{lang:e,r9k:h,slow:k,subs_only:u})}else if("WHISPER"===
e[2]){c=e;e="#d2691e";h="";k=!1;f=g=v=u="";m=c[0].split(";");for(q=0;q<m.length;q++){m[q]=m[q].split("=");var n=m[q][0],r=m[q][1];"display-name"===n?u=""===r?c[1].split("!")[0].substring(1):r:"@color"===n&&""!==r?e=r:"turbo"===n&&"1"==r?k=!0:"emotes"===n&&""!==r?h=r:"message-id"===n&&""!==r?v=r:"thread-id"===n&&""!==r?g=r:"user-id"===n&&""!==r&&(f=r)}m=c.slice(4).join(" ").substring(1);p("whisper",{from:u,to:c[3],color:e,emotes:h,turbo:k,message_id:v,thread_id:g,user_id:f,text:m})}else if("CLEARCHAT"===
e[1])4===e.length?(c=e[3].substring(1),p("clearUser",c)):p("clearChat");else if("USERSTATE"===e[2])for(c=e[0].substring(1).split(";"),e=0;e<c.length;e++)h=c[e].split("="),"color"===h[0]?X=h[1]:"display-name"===h[0]?W=h[1]:"emote-sets"===h[0]?Y=h[1]:"mod"===h[0]?S=h[1]:"subscriber"===h[0]?T=h[1]:"turbo"===h[0]?U=h[1]:"user-type"===h[0]&&(V=h[1])}}}H&&C||console.error("TAPIC not set up, cannot run chat.");l&&b.closeChat();d=a.toLowerCase();l=t?new (require("ws"))("wss://irc-ws.chat.twitch.tv:443"):
new WebSocket("wss://irc-ws.chat.twitch.tv:443");t?(l.on("open",c),l.on("message",f)):(l.onopen=c,l.onmessage=f);Z(function(){D();g&&setTimeout(g,500)})};b.closeChat=function(){if(!l)return console.error("Chat is not open.");l.close();console.log("Chat closed.");l=d="";x=!1;R=K=J=I=E=F=M=L=A=z="";y={};G=[];V=U=T=S=Y=X=W=Q=P=O=N=""};b.changeChannel=function(a){if(!l)return console.error("Chat is not open.");l.send("PART #"+d);d=a;x=!1;R=K=J=I=E=F=M=L=A=z="";y={};G=[];V=U=T=S=Q=P=O=N="";l.send("JOIN #"+
d)};b.sendChat=function(a){if(!l)return console.error("Chat is not open.");l.send("PRIVMSG #"+d+" :"+a);p("echoChat",a)};b.sendWhisper=function(a,b){if(!l)return console.error("Chat is not open.");l.send("PRIVMSG #jtv :/w "+a+" "+b);p("echoWhisper",{to:a,text:b})};b.getUsername=function(){return H};b.getChannel=function(){return d};b.isOnline=function(){return d?x:console.error("Not in a channel.")};b.getStatus=function(){return d?A:console.error("Not in a channel.")};b.getGame=function(){return d?
z:console.error("Not in a channel.")};b.getFollowerCount=function(){return d?L:console.error("Not in a channel.")};b.getTotalViewCount=function(){return d?M:console.error("Not in a channel.")};b.isPartner=function(){return d?F:console.error("Not in a channel.")};b.getCurrentViewCount=function(){return d?E:console.error("Not in a channel.")};b.getFps=function(){return x?I:console.error("Stream not online.")};b.getVideoHeight=function(){return x?J:console.error("Stream not online.")};b.getDelay=function(){return x?
K:console.error("Stream not online.")};b.getSubBadgeUrl=function(){return d?R:console.error("Not in a channel.")};b.getChatters=function(){return d?y:console.error("Not in a channel.")};b.getCreatedAt=function(){return d?N:console.error("Not in a channel.")};b.getLogo=function(){return d?O:console.error("Not in a channel.")};b.getVideoBanner=function(){return d?P:console.error("Not in a channel.")};b.getProfileBanner=function(){return d?Q:console.error("Not in a channel.")};b.getDisplayName=function(){return d?
W:console.error("Not in a channel.")};b.getColor=function(){return d?X:console.error("Not in a channel.")};b.getEmoteSets=function(){return d?Y:console.error("Not in a channel.")};b.getMod=function(){return d?S:console.error("Not in a channel.")};b.getSub=function(){return d?T:console.error("Not in a channel.")};b.getTurbo=function(){return d?U:console.error("Not in a channel.")};b.getUserType=function(){return d?V:console.error("Not in a channel.")};b.isFollowing=function(a,b,c){w("https://api.twitch.tv/kraken/users/"+
a+"/follows/channels/"+b+"?api_version=3&client_id="+k,function(a){a.error?c({isFollowing:!1}):c({isFollowing:!0,dateFollowed:(new Date(a.created_at)).toLocaleString()})})};b.isSubscribing=function(a,b,c){w("https://api.twitch.tv/kraken/channels/"+b+"/subscriptions/"+a+"?api_version=3client_id="+k,function(a){a.error?c({isSubscribing:!1}):c({isSubscribing:!0,dateSubscribed:(new Date(a.created_at)).toLocaleString()})})};b.runCommercial=function(a){F||console.error("Not a partner, cannot run a commercial.");
d||console.error("Not in a channel.");a||(a=30);var b="/kraken/channels/"+d+"/commercial?oauth_token="+C,c="https://api.twitch.tv"+b;t?(c={host:"https://api.twitch.tv",path:b,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","Client-ID":k}},require("https").request(c).write("length="+a).end()):(b=new XMLHttpRequest,b.open("POST",c,!0),b.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),b.setRequestHeader("Client-ID",k),b.send("length="+
a))};b.setStatusGame=function(a,b){a||(a=A);b||(b=z);var c="/kraken/channels/"+d,c=c+("?channel[status]="+encodeURIComponent(a)),c=c+("&channel[game]="+encodeURIComponent(b)),c=c+("&_method=put&oauth_token="+C);if(t)c={host:"https://api.twitch.tv",path:c,headers:{"Client-ID":k}},require("https").get(c,function(a){var b="";a.setEncoding("utf8");a.on("data",function(a){b+=a});a.on("end",function(){if(200<=a.statusCode&&400>a.statusCode){var c=JSON.parse(b);z=c.game;A=c.status}else console.error(b)})}).on("error",
function(a){console.error(a.message)});else{var f=new XMLHttpRequest;f.open("GET","https://api.twitch.tv"+c,!0);f.setRequestHeader("Client-ID",k);f.onload=function(){if(200<=f.status&&400>f.status){var a=JSON.parse(f.responseText);z=a.game;A=a.status}else console.error(f.responseText)};f.onerror=function(){console.error(f.responseText)};f.send()}};b.listen=function(a,b){if(B.has(a)){var c=B.get(a);c.push(b);B.set(a,c)}else B.set(a,[b])};return b}"undefined"!==typeof module&&"undefined"!==typeof module.exports?
module.exports=D():"undefined"===typeof TAPIC?window.TAPIC=D():console.error("TAPIC already defined.")})();
