(function(){function U(){function n(a){var f=new Map;a=a.substring(1).split(";");for(var d=0;d<a.length;d++){var b=a[d].split("=");f.set(b[0],b[1])}return f}function v(){l("https://api.twitch.tv/kraken/streams/"+e+"?client_id="+k+"&api_version=3",function(a){a.stream?(p=!0,z=a.stream.viewers,D=a.stream.average_fps,E=a.stream.video_height,F=a.stream.delay):p=!1});l("https://api.twitch.tv/kraken/channels/"+e+"?client_id="+k+"&api_version=3",function(a){t=a.game;u=a.status;G=a.followers;H=a.views;A=
a.partner;I=a.created_at;J=a.logo;K=a.video_banner;L=a.profile_banner});l("https://api.twitch.tv/kraken/channels/"+e+"/follows?client_id="+k+"&api_version=3&limit=100",function(a){if(a.follows){var f=!0;0<B.length&&(f=!1);for(var d=0;d<a.follows.length;d++){var b=a.follows[d].user.display_name;-1===B.indexOf(b)&&(f||h("follow",b),B.push(b))}}});l("https://tmi.twitch.tv/group/user/"+e+"/chatters?client_id="+k+"&api_version=3",function(a){m||(a=a.data);if(!a.chatters)return console.log("No response for user list.");
z=a.chatter_count;q.moderators=a.chatters.moderators.slice();q.staff=a.chatters.staff.slice();q.admins=a.chatters.admins.slice();q.global_mods=a.chatters.global_mods.slice();q.viewers=a.chatters.viewers.slice()});setTimeout(function(){m||(document.querySelector("#tapicJsonpContainer").innerHTML="");v()},1E4)}function w(a){l("https://api.twitch.tv/kraken/chat/"+e+"/badges?api_version=3&client_id="+k,function(b){b.subscriber&&(M=b.subscriber.image);a&&a()})}function l(a,b){if(m)require("https").get(a,
function(a){var d="";a.setEncoding("utf8");a.on("data",function(a){d+=a});a.on("end",function(){200<=a.statusCode&&400>a.statusCode?b(JSON.parse(d)):console.error(d)})}).on("error",function(a){console.error(a.message)});else{var d;do d="jsonp"+Math.floor(1E6*Math.random());while(window[d]);window[d]=function(a){b(a);delete window[d]};var e=document.createElement("script");e.src=a+"&callback="+d;document.querySelector("#tapicJsonpContainer").appendChild(e)}}function h(a,b){if(x.has(a))for(var d=x.get(a),
e=0;e<d.length;e++)d[e](b)}var b={},k="",y="",C="",e="",g,p=!1,t="",u="",G="",H="",A="",z="",D="",E="",F="",M="",q={},B=[],I="",J="",K="",L="",m=!1,x=new Map,R="",S="",T="",N="",O="",P="",Q="";"undefined"!==typeof module&&"undefined"!==typeof module.exports&&(m=!0);b.setup=function(a,b,d){a&&b?(k=a,y=b.replace("oauth:",""),m||(a=document.createElement("div"),a.id="tapicJsonpContainer",a.style.cssText="display:none;",document.getElementsByTagName("body")[0].appendChild(a)),l("https://api.twitch.tv/kraken?client_id="+
k+"&oauth_token="+y+"&api_version=3",function(a){C=a.token.user_name;d&&d(C)})):console.error("Invalid parameters. Usage: TAPIC.setup(clientid, oauth[, callback]);")};b.runChat=function(a,f){function d(){g.send("CAP REQ :twitch.tv/tags twitch.tv/commands twitch.tv/membership");g.send("PASS oauth:"+y);g.send("NICK "+C);g.send("JOIN #"+e)}function r(a){a=m?a.split("\r\n"):a.data.split("\r\n");for(var b=0;b<a.length;b++){var c=a[b];if("PING :tmi.twitch.tv"===c)g.send("PONG :tmi.twitch.tv");else if(c)if(h("raw",
c),c=c.split(" "),"PRIVMSG"===c[2]){var d=c,c=n(d[0]);c.get("display-name")||c.set("display-name",d[1].split("!")[0].substring(1));c.get("color")||c.set("color","#d2691e");c.set("badges",c.get("badges").split(","));var f=!1,d=d.slice(4);d[0]=d[0].substring(1);"\u0001ACTION"===d[0]&&(d=d.slice(1),f=!0);var r=d.join(" ").replace(/</g,"&lt;").replace(/>/g,"&gt;");"twitchnotify"===c.get("display-name")?"just"===d[1]?h("sub",d[0]):h("subsAway",d[0]):h("message",{from:c.get("display-name"),color:c.get("color"),
mod:1==c.get("mod"),sub:1==c.get("subscriber"),turbo:1==c.get("turbo"),streamer:c.get("display-name").toLowerCase()===e.toLowerCase(),action:f,text:r,emotes:c.get("emotes"),badges:c.get("badges"),room_id:c.get("room-id"),user_id:c.get("user-id")})}else if("PRIVMSG"===c[1])h("host",c[3].substring(1));else if("NOTICE"===c[2])c.splice(0,4),c=c.join(" ").substring(1),h("notice",c);else if("JOIN"===c[1])c=c[0].split("!")[0].substring(1),h("join",c);else if("PART"===c[1])c=c[0].split("!")[0].substring(1),
h("part",c);else if("ROOMSTATE"===c[2])c=n(c[0]),h("roomstate",{lang:c.get("broadcaster-lang"),r9k:c.get("r9k"),slow:c.get("slow"),subs_only:c.get("subs-only")});else if("WHISPER"===c[2])f=n(c[0]),f.get("display-name")||f.set("display-name",c[1].split("!")[0].substring(1)),f.get("color")||f.set("color","#d2691e"),f.set("badges",f.get("badges").split(",")),d=c.slice(4).join(" ").substring(1),h("whisper",{from:f.get("display-name"),to:c[3],color:f.get("color"),emotes:f.get("emotes"),turbo:f.get("turbo"),
message_id:f.get("message-id"),thread_id:f.get("thread-id"),user_id:f.get("user-id"),text:d,badges:f.get("badges")});else if("CLEARCHAT"===c[1])h("clearChat");else if("CLEARCHAT"===c[2]){for(var r=c[0].slice(1).split(";"),f="",d=1,k=0;k<r.length;k++){var l=r[k].split("=");"ban-duration"===l[0]?d=l[1]:"ban-reason"===l[0]&&(f=l[1].replace(/\\s/g," "))}c=c[4].slice(1);h("clearUser",{name:c,reason:f,duration:d})}else"USERSTATE"===c[2]?(c=n(c[0]),S=c.get("color"),R=c.get("display-name"),T=c.get("emote-sets"),
N=c.get("mod"),O=c.get("subscriber"),P=c.get("turbo"),Q=c.get("user-type")):"USERNOTICE"===c[2]&&(f=n(c[0]),c=c.slice(4).join(" ").substring(1),h("subMonths",{name:f.get("display-name"),months:f.get("msg-param-months"),message:c}))}}C&&y||console.error("TAPIC not set up, cannot run chat.");g&&b.closeChat();e=a.toLowerCase();g=m?new (require("ws"))("wss://irc-ws.chat.twitch.tv:443"):new WebSocket("wss://irc-ws.chat.twitch.tv:443");m?(g.on("open",d),g.on("message",r)):(g.onopen=d,g.onmessage=r);w(function(){v();
f&&setTimeout(f,500)})};b.closeChat=function(){if(!g)return console.error("Chat is not open.");g.close();console.log("Chat closed.");g=e="";p=!1;M=F=E=D=z=A=H=G=u=t="";q={};B=[];Q=P=O=N=T=S=R=L=K=J=I=""};b.changeChannel=function(a){if(!g)return console.error("Chat is not open.");g.send("PART #"+e);e=a;p=!1;M=F=E=D=z=A=H=G=u=t="";q={};B=[];Q=P=O=N=L=K=J=I="";g.send("JOIN #"+e)};b.sendChat=function(a){if(!g)return console.error("Chat is not open.");g.send("PRIVMSG #"+e+" :"+a);h("echoChat",a)};b.sendWhisper=
function(a,b){if(!g)return console.error("Chat is not open.");g.send("PRIVMSG #jtv :/w "+a+" "+b);h("echoWhisper",{to:a,text:b})};b.getUsername=function(){return C};b.getChannel=function(){return e};b.isOnline=function(){return e?p:console.error("Not in a channel.")};b.getStatus=function(){return e?u:console.error("Not in a channel.")};b.getGame=function(){return e?t:console.error("Not in a channel.")};b.getFollowerCount=function(){return e?G:console.error("Not in a channel.")};b.getTotalViewCount=
function(){return e?H:console.error("Not in a channel.")};b.isPartner=function(){return e?A:console.error("Not in a channel.")};b.getCurrentViewCount=function(){return e?z:console.error("Not in a channel.")};b.getFps=function(){return p?D:console.error("Stream not online.")};b.getVideoHeight=function(){return p?E:console.error("Stream not online.")};b.getDelay=function(){return p?F:console.error("Stream not online.")};b.getSubBadgeUrl=function(){return e?M:console.error("Not in a channel.")};b.getChatters=
function(){return e?q:console.error("Not in a channel.")};b.getCreatedAt=function(){return e?I:console.error("Not in a channel.")};b.getLogo=function(){return e?J:console.error("Not in a channel.")};b.getVideoBanner=function(){return e?K:console.error("Not in a channel.")};b.getProfileBanner=function(){return e?L:console.error("Not in a channel.")};b.getDisplayName=function(){return e?R:console.error("Not in a channel.")};b.getColor=function(){return e?S:console.error("Not in a channel.")};b.getEmoteSets=
function(){return e?T:console.error("Not in a channel.")};b.getMod=function(){return e?N:console.error("Not in a channel.")};b.getSub=function(){return e?O:console.error("Not in a channel.")};b.getTurbo=function(){return e?P:console.error("Not in a channel.")};b.getUserType=function(){return e?Q:console.error("Not in a channel.")};b.isFollowing=function(a,b,d){l("https://api.twitch.tv/kraken/users/"+a+"/follows/channels/"+b+"?api_version=3&client_id="+k,function(a){a.error?d({isFollowing:!1}):d({isFollowing:!0,
dateFollowed:(new Date(a.created_at)).toLocaleString()})})};b.isSubscribing=function(a,b,d){l("https://api.twitch.tv/kraken/channels/"+b+"/subscriptions/"+a+"?api_version=3client_id="+k,function(a){a.error?d({isSubscribing:!1}):d({isSubscribing:!0,dateSubscribed:(new Date(a.created_at)).toLocaleString()})})};b.runCommercial=function(a){A||console.error("Not a partner, cannot run a commercial.");e||console.error("Not in a channel.");a||(a=30);var b="/kraken/channels/"+e+"/commercial?oauth_token="+
y,d="https://api.twitch.tv"+b;m?(d={host:"https://api.twitch.tv",path:b,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","Client-ID":k}},require("https").request(d).write("length="+a).end()):(b=new XMLHttpRequest,b.open("POST",d,!0),b.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),b.setRequestHeader("Client-ID",k),b.send("length="+a))};b.setStatusGame=function(a,b){a||(a=u);b||(b=t);var d="/kraken/channels/"+e,d=d+("?channel[status]="+
encodeURIComponent(a)),d=d+("&channel[game]="+encodeURIComponent(b)),d=d+("&_method=put&oauth_token="+y);if(m)d={host:"https://api.twitch.tv",path:d,headers:{"Client-ID":k}},require("https").get(d,function(a){var b="";a.setEncoding("utf8");a.on("data",function(a){b+=a});a.on("end",function(){if(200<=a.statusCode&&400>a.statusCode){var c=JSON.parse(b);t=c.game;u=c.status}else console.error(b)})}).on("error",function(a){console.error(a.message)});else{var g=new XMLHttpRequest;g.open("GET","https://api.twitch.tv"+
d,!0);g.setRequestHeader("Client-ID",k);g.onload=function(){if(200<=g.status&&400>g.status){var a=JSON.parse(g.responseText);t=a.game;u=a.status}else console.error(g.responseText)};g.onerror=function(){console.error(g.responseText)};g.send()}};b.listen=function(a,b){if(x.has(a)){var d=x.get(a);d.push(b);x.set(a,d)}else x.set(a,[b])};b.emit=function(a,b){h(a,b)};return b}"function"!==typeof Map&&(window.Map=function(){var n=[],v=[];return{get:function(w){return v[n.indexOf(w)]},set:function(w,l){var h=
n.indexOf(w);-1==h?(n.push(w),v.push(l)):v[h]=l}}});"undefined"!==typeof module&&"undefined"!==typeof module.exports?module.exports=U():"undefined"===typeof TAPIC?window.TAPIC=U():console.error("TAPIC already defined.")})();
