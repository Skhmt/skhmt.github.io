(function(){function D(){function D(){p("https://api.twitch.tv/kraken/streams/"+d+"?client_id="+h+"&api_version=3",function(a){a.stream?(q=!0,E=a.stream.viewers,I=a.stream.average_fps,J=a.stream.video_height,K=a.stream.delay):q=!1});p("https://api.twitch.tv/kraken/channels/"+d+"?client_id="+h+"&api_version=3",function(a){z=a.game;A=a.status;L=a.followers;M=a.views;F=a.partner;N=a.created_at;O=a.logo;P=a.video_banner;Q=a.profile_banner});p("https://api.twitch.tv/kraken/channels/"+d+"/follows?client_id="+
h+"&api_version=3&limit=100",function(a){if(a.follows){var b=!0;0<G.length&&(b=!1);for(var c=0;c<a.follows.length;c++){var d=a.follows[c].user.display_name;-1===G.indexOf(d)&&(b||u("follow",d),G.push(d))}}});p("https://tmi.twitch.tv/group/user/"+d+"/chatters?client_id="+h+"&api_version=3",function(a){x||(a=a.data);if(!a.chatters)return console.log("No response for user list.");E=a.chatter_count;y.moderators=a.chatters.moderators.slice();y.staff=a.chatters.staff.slice();y.admins=a.chatters.admins.slice();
y.global_mods=a.chatters.global_mods.slice();y.viewers=a.chatters.viewers.slice()});setTimeout(function(){x||(document.querySelector("#tapicJsonpContainer").innerHTML="");D()},1E4)}function Z(a){p("https://api.twitch.tv/kraken/chat/"+d+"/badges?api_version=3&client_id="+h,function(d){d.subscriber&&(R=d.subscriber.image);a&&a()})}function p(a,d){if(x)require("https").get(a,function(a){var b="";a.setEncoding("utf8");a.on("data",function(a){b+=a});a.on("end",function(){200<=a.statusCode&&400>a.statusCode?
d(JSON.parse(b)):console.error(b)})}).on("error",function(a){console.error(a.message)});else{var c;do c="jsonp"+Math.floor(1E6*Math.random());while(window[c]);window[c]=function(a){d(a);delete window[c]};var b=document.createElement("script");b.src=a+"&callback="+c;document.querySelector("#tapicJsonpContainer").appendChild(b)}}function u(a,b){if(C.has(a))for(var d=C.get(a),f=0;f<d.length;f++)d[f](b)}var b={},h="",B="",H="",d="",l,q=!1,z="",A="",L="",M="",F="",E="",I="",J="",K="",R="",y={},G=[],N=
"",O="",P="",Q="",x=!1,C=new Map,W="",X="",Y="",S="",T="",U="",V="";"undefined"!==typeof module&&"undefined"!==typeof module.exports&&(x=!0);b.setup=function(a,d,b){a&&d?(h=a,B=d,B.replace("oauth:",""),x||(a=document.createElement("div"),a.id="tapicJsonpContainer",a.style.cssText="display:none;",document.getElementsByTagName("body")[0].appendChild(a)),p("https://api.twitch.tv/kraken?client_id="+h+"&oauth_token="+B+"&api_version=3",function(a){H=a.token.user_name;b&&b(H)})):console.error("Invalid parameters. Usage: TAPIC.setup(clientid, oauth[, callback]);")};
b.runChat=function(a,m){function c(){l.send("CAP REQ :twitch.tv/tags twitch.tv/commands twitch.tv/membership");l.send("PASS oauth:"+B);l.send("NICK "+H);l.send("JOIN #"+d)}function f(a){a=x?a.split("\r\n"):a.data.split("\r\n");for(var b=0;b<a.length;b++){var e=a[b];if("PING :tmi.twitch.tv"===e)l.send("PONG :tmi.twitch.tv");else if(e)if(u("raw",e),e=e.split(" "),"PRIVMSG"===e[2]){var c=e[0];e.splice(0,1);for(var m=e,f=c.slice(1).split(";"),e="#d2691e",g=c=!1,h=!1,v="",r="",t=[],p="",q="",n=0;n<f.length;n++){f[n]=
f[n].split("=");var k=f[n][0],w=f[n][1];"display-name"===k?v=""===w?m[0].split("!")[0].substring(1):w:"color"===k&&""!==w?e=w:"mod"===k&&"1"==w?c=!0:"subscriber"===k&&"1"==w?g=!0:"turbo"===k&&"1"==w?h=!0:"emotes"===k&&""!==w?r=w:"badges"===k?t=w.split(","):"room-id"===k?p=w:"user-id"===k&&(q=w)}f=!1;n=m[3].substring(1);m.splice(0,4);m=m.join(" ");"\u0001ACTION"===n?(n=m,f=!0):n+=" "+m;m=n.replace(/</g,"&lt;").replace(/>/g,"&gt;");u("message",{from:v,color:e,mod:c,sub:g,turbo:h,streamer:v.toLowerCase()===
d.toLowerCase(),action:f,text:m,emotes:r,badges:t,room_id:p,user_id:q})}else if("PRIVMSG"===e[1])u("host",e[3].substring(1));else if("NOTICE"===e[2])e.splice(0,4),e=e.join(" ").substring(1),u("notice",e);else if("JOIN"===e[1])e=e[0].split("!")[0].substring(1),u("join",e);else if("PART"===e[1])e=e[0].split("!")[0].substring(1),u("part",e);else if("ROOMSTATE"===e[2]){e=e[0].substring(1).split(";");v=h=g=c=void 0;for(r=0;r<e.length;r++)t=e[r].split("="),"broadcaster-lang"===t[0]?c=t[1]:"r9k"===t[0]?
g=t[1]:"slow"===t[0]?h=t[1]:"subs-only"===t[0]&&(v=t[1]);u("roomstate",{lang:c,r9k:g,slow:h,subs_only:v})}else if("WHISPER"===e[2]){c="#d2691e";g="";h=!1;p=t=r=v="";q=[];m=e[0].slice(1).split(";");for(f=0;f<m.length;f++)m[f]=m[f].split("="),n=m[f][0],k=m[f][1],"display-name"===n?v=""===k?e[1].split("!")[0].substring(1):k:"color"===n&&""!==k?c=k:"turbo"===n&&"1"==k?h=!0:"emotes"===n&&""!==k?g=k:"message-id"===n&&""!==k?r=k:"thread-id"===n&&""!==k?t=k:"user-id"===n&&""!==k?p=k:"badges"==n&&(q=k.split(","));
m=e.slice(4).join(" ").substring(1);u("whisper",{from:v,to:e[3],color:c,emotes:g,turbo:h,message_id:r,thread_id:t,user_id:p,text:m,badges:q})}else if("CLEARCHAT"===e[1])u("clearChat");else if("CLEARCHAT"===e[2]){h=e[0].slice(1).split(";");c="";g=1;for(v=0;v<h.length;v++)r=h[v].split("="),"ban-duration"===r[0]?g=r[1]:"ban-reason"===r[0]&&(c=r[1].replace(/\\s/g," "));e=e[4].slice(1);u("clearUser",{name:e,reason:c,duration:g})}else if("USERSTATE"===e[2])for(e=e[0].substring(1).split(";"),c=0;c<e.length;c++)g=
e[c].split("="),"color"===g[0]?X=g[1]:"display-name"===g[0]?W=g[1]:"emote-sets"===g[0]?Y=g[1]:"mod"===g[0]?S=g[1]:"subscriber"===g[0]?T=g[1]:"turbo"===g[0]?U=g[1]:"user-type"===g[0]&&(V=g[1])}}H&&B||console.error("TAPIC not set up, cannot run chat.");l&&b.closeChat();d=a.toLowerCase();l=x?new (require("ws"))("wss://irc-ws.chat.twitch.tv:443"):new WebSocket("wss://irc-ws.chat.twitch.tv:443");x?(l.on("open",c),l.on("message",f)):(l.onopen=c,l.onmessage=f);Z(function(){D();m&&setTimeout(m,500)})};b.closeChat=
function(){if(!l)return console.error("Chat is not open.");l.close();console.log("Chat closed.");l=d="";q=!1;R=K=J=I=E=F=M=L=A=z="";y={};G=[];V=U=T=S=Y=X=W=Q=P=O=N=""};b.changeChannel=function(a){if(!l)return console.error("Chat is not open.");l.send("PART #"+d);d=a;q=!1;R=K=J=I=E=F=M=L=A=z="";y={};G=[];V=U=T=S=Q=P=O=N="";l.send("JOIN #"+d)};b.sendChat=function(a){if(!l)return console.error("Chat is not open.");l.send("PRIVMSG #"+d+" :"+a);u("echoChat",a)};b.sendWhisper=function(a,b){if(!l)return console.error("Chat is not open.");
l.send("PRIVMSG #jtv :/w "+a+" "+b);u("echoWhisper",{to:a,text:b})};b.getUsername=function(){return H};b.getChannel=function(){return d};b.isOnline=function(){return d?q:console.error("Not in a channel.")};b.getStatus=function(){return d?A:console.error("Not in a channel.")};b.getGame=function(){return d?z:console.error("Not in a channel.")};b.getFollowerCount=function(){return d?L:console.error("Not in a channel.")};b.getTotalViewCount=function(){return d?M:console.error("Not in a channel.")};b.isPartner=
function(){return d?F:console.error("Not in a channel.")};b.getCurrentViewCount=function(){return d?E:console.error("Not in a channel.")};b.getFps=function(){return q?I:console.error("Stream not online.")};b.getVideoHeight=function(){return q?J:console.error("Stream not online.")};b.getDelay=function(){return q?K:console.error("Stream not online.")};b.getSubBadgeUrl=function(){return d?R:console.error("Not in a channel.")};b.getChatters=function(){return d?y:console.error("Not in a channel.")};b.getCreatedAt=
function(){return d?N:console.error("Not in a channel.")};b.getLogo=function(){return d?O:console.error("Not in a channel.")};b.getVideoBanner=function(){return d?P:console.error("Not in a channel.")};b.getProfileBanner=function(){return d?Q:console.error("Not in a channel.")};b.getDisplayName=function(){return d?W:console.error("Not in a channel.")};b.getColor=function(){return d?X:console.error("Not in a channel.")};b.getEmoteSets=function(){return d?Y:console.error("Not in a channel.")};b.getMod=
function(){return d?S:console.error("Not in a channel.")};b.getSub=function(){return d?T:console.error("Not in a channel.")};b.getTurbo=function(){return d?U:console.error("Not in a channel.")};b.getUserType=function(){return d?V:console.error("Not in a channel.")};b.isFollowing=function(a,b,c){p("https://api.twitch.tv/kraken/users/"+a+"/follows/channels/"+b+"?api_version=3&client_id="+h,function(a){a.error?c({isFollowing:!1}):c({isFollowing:!0,dateFollowed:(new Date(a.created_at)).toLocaleString()})})};
b.isSubscribing=function(a,b,c){p("https://api.twitch.tv/kraken/channels/"+b+"/subscriptions/"+a+"?api_version=3client_id="+h,function(a){a.error?c({isSubscribing:!1}):c({isSubscribing:!0,dateSubscribed:(new Date(a.created_at)).toLocaleString()})})};b.runCommercial=function(a){F||console.error("Not a partner, cannot run a commercial.");d||console.error("Not in a channel.");a||(a=30);var b="/kraken/channels/"+d+"/commercial?oauth_token="+B,c="https://api.twitch.tv"+b;x?(c={host:"https://api.twitch.tv",
path:b,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","Client-ID":h}},require("https").request(c).write("length="+a).end()):(b=new XMLHttpRequest,b.open("POST",c,!0),b.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),b.setRequestHeader("Client-ID",h),b.send("length="+a))};b.setStatusGame=function(a,b){a||(a=A);b||(b=z);var c="/kraken/channels/"+d,c=c+("?channel[status]="+encodeURIComponent(a)),c=c+("&channel[game]="+encodeURIComponent(b)),
c=c+("&_method=put&oauth_token="+B);if(x)c={host:"https://api.twitch.tv",path:c,headers:{"Client-ID":h}},require("https").get(c,function(a){var b="";a.setEncoding("utf8");a.on("data",function(a){b+=a});a.on("end",function(){if(200<=a.statusCode&&400>a.statusCode){var c=JSON.parse(b);z=c.game;A=c.status}else console.error(b)})}).on("error",function(a){console.error(a.message)});else{var f=new XMLHttpRequest;f.open("GET","https://api.twitch.tv"+c,!0);f.setRequestHeader("Client-ID",h);f.onload=function(){if(200<=
f.status&&400>f.status){var a=JSON.parse(f.responseText);z=a.game;A=a.status}else console.error(f.responseText)};f.onerror=function(){console.error(f.responseText)};f.send()}};b.listen=function(a,b){if(C.has(a)){var c=C.get(a);c.push(b);C.set(a,c)}else C.set(a,[b])};return b}"undefined"!==typeof module&&"undefined"!==typeof module.exports?module.exports=D():"undefined"===typeof TAPIC?window.TAPIC=D():console.error("TAPIC already defined.")})();
